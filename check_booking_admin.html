<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <title> Softway 舒微生活管理員</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">

    <!-- Bootstrap core JavaScript and jquery-->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.7.1/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <!--影響 Close < > 的切換icon-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--引用plugin的css(自行到作者GitHub下載)-->
    <link rel="stylesheet" href="css/bootstrap-material-datetimepicker.css" />
    <!-- Datepicker ----------------->
    <script src="https://use.fontawesome.com/releases/v5.0.9/js/all.js"></script>
    <script src="https://use.fontawesome.com/releases/v5.0.9/js/v4-shims.js"></script>
    <!--  引用jQuery------------------>
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <!--此plugin會影響語系-------------->
    <script type="text/javascript" src="https://momentjs.com/downloads/moment-with-locales.js"></script>
    <!--引用plugin的js----------------->
    <script src="js/bootstrap-material-datetimepicker.js"></script>

    <style>
        .dtp-buttons > button.btn {
            border: none;
            border-radius: 15px;
            position: relative;
            box-shadow: none;
            color: rgba(0,0,0, 0.87);
            padding: 5px 40px;
            font-size: 20px;
            margin: 5px 5px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0;
            will-change: box-shadow, transform;
            transition: box-shadow 0.2s cubic-bezier(0.4, 0, 1, 1), background-color 0.2s cubic-bezier(0.4, 0, 0.2, 1), color 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: 0;
            cursor: pointer;
            text-decoration: none;
            background: transparent;
        }
            .dtp-buttons > button.btn:hover,
            .dtp-buttons > button.btn:focus {
                background-color: rgba(153, 153, 153, 0.2);
            }
            /*我自己多寫這個*/
         /* .dtp-picker-calendar > table {
            width: 100%;
        } */
    </style>

<style>
        .w3-myfont {
        font-family: "Comic Sans MS", cursive, sans-serif;
        }

        @media screen and (max-width: 600px) {
            .w3-bordered thead {
                display: none;
            }
            .w3-bordered td {
                display: flex;
            }

            .w3-bordered td::before {
                content: attr(label);
                font-weight: bold;
                width: 120px;
                min-width: 120px;
            }
    
        }
</style>
</head>

<body>

<!-- Page Content -->
<div class="container">
        <div class="row">
            <div class="col-lg-12">
                <!-- profile -->
                <div class="w3-center w3-animate-top w3-padding-small">
                    <img id="img" src="https://upload.wikimedia.org/wikipedia/commons/3/3a/Cat03.jpg" class="w3-circle" style="width:115px">
                    <p style="font-size:135%;"><b id="displayname">管理員訂位查詢</b></p><hr>
                </div>

                <div>
                    <font size="4">
                         <label><span class="glyphicon glyphicon-cutlery"></i> <b>店家</b></label>
                             <select id="store_name" class="w3-input w3-border w3-round-large" value="" required>
                                    <option style="display:none" value="">請選擇店家</option>
                                    <option value="總店">總店</option>
                            </select>
                    </font>
                    <br>
                    <font size="4">
                            <label><span class="glyphicon glyphicon-calendar"></i> <b>日期</b></label>
                                <input class="w3-input w3-border w3-round-large" id="date" type="text" value="" placeholder="請選擇日期" required>
                    </font>

                    <font size='4'>
                    <button id='send' class="w3-btn w3-round-large w3-block w3-teal w3-padding-16 w3-section w3-right"> 查詢 <span class="glyphicon glyphicon-search"></span> </button>
                    </font>
                </div>
                
                
                
                
                    <table class="table w3-bordered" style="display: none;">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>電話</th>
                                <th>訂位日期</th>
                                <th>時段</th>
                                <th>成人</th>
                                <th>小孩</th>
                                <th>價位</th>
                                <th>店名</th>
                                <th>備註</th>
                                <th>動作</th>
                            </tr>
                        </thead>
                        <tbody id="dataView">
                        </tbody>
                    </table>
            </div>
        </div>
    </div>

    <!-- Page Content
    <div class="container">
        <div class="row">
            <div class="col-lg-12 text-center">
                <h1 class="mt-5">管理員訂位查詢</h1>

                <div class="form-group col-xs-12">
                    <label for="pwd">店家:</label>
                    <select name="store_name" id="store_name" class="select form-control" data-price="50" data-name="店家">
                        <option style="display:none" value="">請選擇店家</option>
                        <option value="總店">總店</option>
                    </select>

                </div>
                <div class="form-group col-xs-12">
                    <label for="pwd">日期:</label>
                    <form>
                        <div class="form-group">
                            <div class='input-group date' id='datepicker'>
                                <input type='text' class="form-control" readonly />
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="form-group col-xs-12">
                    <button type="button" id="send" class="btn btn-primary col-xs-12">送出查詢</button>
                </div>
                <div class="form-group col-xs-12">
                    <table class="table table-striped" style="display: none;">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>稱呼</th>
                                <th>電話</th>
                                <th>訂位日期</th>
                                <th>開始時間</th>
                                <th>結束時間</th>
                                <th>成人人數</th>
                                <th>小孩人數</th>
                                <th>店名</th>
                                <th>備註</th>
                            </tr>
                        </thead>
                        <tbody id="dataView">
                        </tbody>
                    </table>
                </div>
                <div class="col-xs-12 text-center"><a href=""></a></div>
            </div>
        </div>
    </div> -->



    
    <script>
            window.setMobileTable = function(selector) {
            // if (window.innerWidth > 600) return false;
            // const tableEl = document.querySelector(selector);
            // const thEls = tableEl.querySelectorAll('thead th');
            // const tdLabels = Array.from(thEls).map(el => el.innerText);
            
            // tableEl.querySelectorAll('tbody tr').forEach( tr => {
            //     Array.from(tr.children).forEach( 
            //     (td, ndx) =>  td.setAttribute('label', tdLabels[ndx])
            //     );
            // });
            }
            setMobileTable('table');
        </script>


    <!--datetimepicker of parameter--->
    <script type="text/javascript">
        $(function () {
        $('#date').bootstrapMaterialDatePicker(
            {
                time: false, nowButton:false, clearButton: false, okText: '確認', cancelText: '取消', format: 'YYYY/MM/DD dddd'
            });
        });
    </script>

    <script>
        // $(function () {
        //     $('#datepicker').datepicker({
        //         format: "YYYY/MM/DD dddd",
        //         autoclose: true,
        //         todayHighlight: true,
        //         showOtherMonths: true,
        //         selectOtherMonths: true,
        //         autoclose: true,
        //         changeMonth: true,
        //         changeYear: true,
        //         orientation: "button",
        //     });
        // });
        $(function () {
            $('#send').click(function (e) {
                var status = true;
                var date = $('#date').val();
                var store = $('#store_name').val();
                // var d = $("#datepicker").datepicker("getDate");
                // $('input').focus(function () {
                //     $(this).css('border', '');
                // });
                if (store == '') {
                    $('#store_name').css('border', '1px solid #ff0000');
                    alert('請選擇訂位的店家喔');
                    status = false;
                }
                else if (date == '') {
                    $('#datepicker').css('border', '1px solid #ff0000');
                    status = false;
                    alert('請選擇訂位的日期');
                }
                if (status) {
                    // var booking_date = d.getFullYear() + "-" + ('0' + (d.getMonth() + 1)).slice(-2) + "-" + ('0' + d.getDate()).slice(-2)
                    var data = {
                        'store': store,
                        'booking_date': date,
                        'action': 'querying_boss'
                    }
                    
                    $("#send").attr("disabled", true);
                    sendQuery(data);
                }
            });
        });

        function handleData(response) {
            var content = '';
            response.result.sort(function (a, b) {
                var adate = a[2];
                var bdate = b[2];
                var a_stime = a[3];
                var b_stime = b[3];
                var a_etime = a[4];
                var b_etime = b[4];
                var a_store = a[8];
                var b_store = b[8];   
                if (a_store === b_store) {
                    if (adate === bdate) {
                        if (a_stime === b_stime){
                            return (a_etime < b_etime) ? -1 : (a_etime > b_etime) ? 1 : 0;
                        }else{
                            return (a_stime< b_stime) ? -1 : 1;
                        }

                    } else {
                        return (adate < bdate) ? -1 : 1;
                    }
                } else {
                    return (a_store < b_store) ? -1 : 1;
                }
            });
            response.result.forEach(element => {

                var [userid, name, gender, phone, bk_date, bk_st, t_session, when, adult, children, store, ps, price,status, index] = element;

                if (bk_st %60 != 0){
                    bk_st = parseInt(bk_st/60).toString()+':'+(bk_st%60).toString()
                }
                else{
                    bk_st = (bk_st/60).toString()+':00'
                }
                // if(sex == 'M'){
                //     var gender = '先生'
                // }
                // else{
                //     var gender = '女士'
                // }
                content +=
                    `<tr>
                <td label='Line用戶'>${name}</td>    
                <td label='電話'>${phone}</td>
                <td label='訂位日期'>${bk_date}</td>
                <td label='時段'>${bk_st}</td>
                <td label='成人'>${adult}</td>
                <td label='小孩'>${children}</td>
                <td label='價格'>${price}</td>
                <td label='店家'>${store}</td>
                <td label=' 備註'>${ps}</td>
                <td>
                  <button type="button" onclick="updateStatus('${name}', '${phone}', '${index}','${store}' ,this)" class="btn btn-primary">取消訂單</button>
                </td>
              </tr>`
            });
            if (content) {
                document.getElementsByClassName('w3-bordered')[0].style.display = 'table';
            } else {
                alert('查無資料');
            }
            var dataView = document.getElementById('dataView');
            dataView.innerHTML = content;
        }

        function sendQuery(data) {
            $.ajax({
                type: "post",
                url: "https://script.google.com/macros/s/AKfycbz4QU7y1coY0DPM8sBFumKxKabm7xOVtIxE0Lzt4IMz-qTmH6w/exec",
                data: data,
                success: function (response) {
                    if (response.result == 'error') {
                        alert("資料不存在，請確認輸入資料是否正確")
                    }
                    else {
                        handleData(response);
                    }
                    $("#send").attr("disabled", false);
                    $('#name').val('');
                    $('#phone').val('');
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    $("#send").attr("disabled", false);
                    $('#name').val('');
                    $('#phone').val('');
                    alert('很抱歉，查詢失敗!!')
                }

            });
        }
        function updateStatus(name, phone, index, store, that) {
            var data = {
                name: name,
                phone: phone,
                action: 'del',
                index: index,
                store: store
            };
            $.ajax({
                type: "post",
                url: "https://script.google.com/macros/s/AKfycbz4QU7y1coY0DPM8sBFumKxKabm7xOVtIxE0Lzt4IMz-qTmH6w/exec",
                data: data,
                success: function (response) {
                    if (response.result === 'success') {
                        var i = that.parentNode.parentNode.rowIndex;
                        document.getElementById("dataView").deleteRow(parseInt(i)-1);
                        
                        alert('更新成功! ')

                    } else {
                        alert('更新失敗！');
                    }
                    $("#send").attr("disabled", false);
                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    alert('很抱歉，更新失敗!!')
                    $("#send").attr("disabled", false);
                }
            });
        }
    </script>
</body>

</html>